<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achetez TEST - La Crypto du Futur</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.11/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronweb@4.0.0/dist/TronWeb.min.js"></script>
</head>
<body>

    <header>
        <div class="container">
            <div class="logo">
                <img src="images/test-logo.png" alt="Logo TEST" width="50">
                <span>TEST</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#">À Propos</a></li>
                    <li><a href="#">Fonctionnalités</a></li>
                    <li><a href="#">Roadmap</a></li>
                    <li><a href="#">FAQ</a></li>
                </ul>
            </nav>
            <div class="wallet-connect">
                <button id="connect-metamask">Connecter MetaMask</button>
                <button id="connect-tronlink">Connecter TronLink</button>
            </div>
        </div>
    </header>

    <main>
        <section id="buy-test" class="buy-section">
            <div class="container">
                <h2>Acheter TEST</h2>
                <p>Achetez TEST facilement et en toute sécurité. Connectez votre portefeuille et suivez les instructions.</p>

                <div class="buy-form">
                    <label for="amount">Montant en BNB/TRX</label>
                    <input type="number" id="amount" placeholder="Entrez le montant" step="0.01" min="0">
                    <button class="button secondary" id="buy-button">Acheter</button>
                </div>
                <p class="disclaimer">Avertissement: L'investissement dans les cryptomonnaies comporte des risques. Veuillez investir de manière responsable.</p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>© 2024 TEST. Tous droits réservés.</p>
            <p><a href="#">Mentions Légales</a> | <a href="#">Conditions d'Utilisation</a></p>
        </div>
    </footer>

    <script>
        let web3, contract;
        let tronWeb;
        let activeWallet = null; // Pour suivre quel portefeuille est utilisé

        const contractAddress = "0xbCD066737b2237B24F09481458356F69f63155b3"; // Adresse du contrat TEST sur le testnet BSC
        const abi = [
            "function buy() public payable" // ABI simplifié de la fonction d'achat
        ];

        // Fonction pour connecter MetaMask
        async function connectMetaMask() {
            if (window.ethereum) {
                // Vérifier si MetaMask est installé
                if (window.ethereum.isMetaMask) {
                    try {
                        // Demander à MetaMask de nous connecter
                        await window.ethereum.request({ method: 'eth_requestAccounts' });
                        web3 = new Web3(window.ethereum);
                        activeWallet = 'MetaMask';

                        // Vérifier le réseau
                        const network = await web3.eth.net.getId();
                        if (network !== 97) { // Testnet BSC
                            await switchToBSCTestnet();
                        }

                        alert("MetaMask connecté !");
                    } catch (err) {
                        console.error("Erreur de connexion à MetaMask :", err);
                        alert("Erreur de connexion. Assurez-vous que MetaMask est bien installé.");
                    }
                } else {
                    alert("MetaMask n'est pas installé.");
                }
            } else {
                alert("Extension MetaMask non détectée.");
            }
        }

        // Fonction pour connecter TronLink
        async function connectTronLink() {
            if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                tronWeb = window.tronWeb;
                activeWallet = 'TronLink';
                alert("TronLink connecté : " + tronWeb.defaultAddress.base58);
            } else {
                alert("TronLink n'est pas installé ou non connecté.");
            }
        }

        // Ajouter ou basculer vers le testnet Binance Smart Chain
        async function switchToBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x61', // Testnet BSC Chain ID en hexadécimal
                        chainName: 'Binance Smart Chain Testnet',
                        rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                        nativeCurrency: {
                            name: 'Binance Coin',
                            symbol: 'BNB',
                            decimals: 18
                        },
                        blockExplorerUrls: ['https://testnet.bscscan.com']
                    }]
                });
                alert("Réseau Binance Smart Chain Testnet ajouté.");
            } catch (err) {
                console.error("Erreur lors du changement de réseau :", err);
            }
        }

        // Acheter des tokens TEST
        async function acheterTEST() {
            const amount = document.getElementById('amount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert("Veuillez entrer un montant valide.");
                return;
            }

            if (activeWallet === 'MetaMask') {
                try {
                    contract = new web3.eth.Contract(abi, contractAddress);
                    const accounts = await web3.eth.getAccounts();
                    const tx = await contract.methods.buy().send({ from: accounts[0], value: web3.utils.toWei(amount, 'ether') });
                    alert("Achat en cours via MetaMask. Transaction ID : " + tx.transactionHash);
                } catch (err) {
                    console.error("Erreur lors de l'achat avec MetaMask :", err);
                    alert("Erreur lors de l'achat avec MetaMask.");
                }
            } else if (activeWallet === 'TronLink') {
                try {
                    const tx = await tronWeb.trx.sendTransaction(contractAddress, tronWeb.toSun(amount));
                    alert("Achat en cours via TronLink. Transaction ID : " + tx.txid);
                } catch (err) {
                    console.error("Erreur lors de l'achat avec TronLink :", err);
                    alert("Erreur lors de l'achat avec TronLink.");
                }
            } else {
                alert("Veuillez connecter un portefeuille.");
            }
        }

        // Ajouter les événements
        document.getElementById('connect-metamask').addEventListener('click', connectMetaMask);
        document.getElementById('connect-tronlink').addEventListener('click', connectTronLink);
        document.getElementById('buy-button').addEventListener('click', acheterTEST);
    </script>
</body>
</html>
